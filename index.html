<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dual Camera Feed</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@300;400;500;600&display=swap');

  :root {
    --bg-deep:     #0a0e14;
    --bg-panel:    #111820;
    --bg-inset:    #0d1117;
    --border:      #1e2a3a;
    --accent:      #e8a025;
    --accent-dim:  #a07018;
    --text-primary:#d4dce8;
    --text-dim:    #5a6a7a;
    --status-on:   #3ddc84;
    --status-off:  #e04848;
    --font-mono:   'Share Tech Mono', 'Courier New', monospace;
    --font-ui:     'Rajdhani', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    min-height: 100vh;
    background: var(--bg-deep);
    color: var(--text-primary);
    font-family: var(--font-mono);
    padding: 20px;
  }

  /* Scanline overlay */
  body::after {
    content: '';
    position: fixed; inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent 0px,
      transparent 2px,
      rgba(0,0,0,.15) 2px,
      rgba(0,0,0,.15) 4px
    );
    pointer-events: none;
    z-index: 999;
  }

  .header {
    text-align: center;
    margin-bottom: 30px;
  }

  .header h1 {
    font-family: var(--font-ui);
    font-weight: 600;
    font-size: 28px;
    letter-spacing: 4px;
    text-transform: uppercase;
    color: var(--accent);
  }

  .camera-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 30px;
    max-width: 1400px;
    margin: 0 auto;
  }

  .camera-card {
    background: var(--bg-panel);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }

  .camera-header {
    padding: 15px 20px;
    background: var(--bg-inset);
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .camera-title {
    font-family: var(--font-ui);
    font-size: 16px;
    font-weight: 600;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
  }

  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--status-off);
    transition: background .3s;
  }

  .status-dot.connected {
    background: var(--status-on);
    box-shadow: 0 0 10px var(--status-on);
  }

  .video-container {
    position: relative;
    background: #000;
    aspect-ratio: 4/3;
  }

  video {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }

  .no-signal {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 15px;
    background: rgba(10,14,20,.95);
    transition: opacity .3s;
  }

  .no-signal.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .no-signal .icon {
    font-size: 48px;
    opacity: .4;
  }

  .no-signal span {
    font-size: 14px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-dim);
  }

  .osd {
    position: absolute;
    bottom: 12px;
    left: 16px;
    font-size: 11px;
    color: rgba(212,220,232,.8);
    text-shadow: 0 1px 3px rgba(0,0,0,.8);
    pointer-events: none;
  }

  .live-badge {
    display: inline-block;
    background: var(--status-on);
    color: #fff;
    font-weight: 700;
    letter-spacing: 1.5px;
    padding: 3px 8px;
    border-radius: 3px;
    margin-right: 8px;
  }

  .controls {
    padding: 20px;
    text-align: center;
  }

  .btn {
    background: var(--accent);
    color: var(--bg-deep);
    border: none;
    padding: 12px 32px;
    font-family: var(--font-ui);
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 2px;
    text-transform: uppercase;
    border-radius: 4px;
    cursor: pointer;
    transition: all .3s;
  }

  .btn:hover {
    background: var(--text-primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(232,160,37,.3);
  }

  .btn:disabled {
    opacity: .5;
    cursor: not-allowed;
  }

  .btn.disconnect {
    background: var(--status-off);
    margin-left: 12px;
  }

  .btn.disconnect:hover {
    background: #ff6b6b;
  }

  .log-section {
    max-width: 1400px;
    margin: 30px auto 0;
    background: var(--bg-panel);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
  }

  .log-title {
    font-family: var(--font-ui);
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--accent-dim);
    margin-bottom: 12px;
  }

  .log-box {
    background: var(--bg-inset);
    border: 1px solid var(--border);
    border-radius: 4px;
    height: 150px;
    overflow-y: auto;
    padding: 10px;
    font-size: 11px;
    line-height: 1.6;
  }

  .log-line {
    margin-bottom: 2px;
  }

  .log-line .ts {
    color: var(--accent-dim);
    margin-right: 8px;
  }

  .log-line.info { color: var(--text-dim); }
  .log-line.success { color: var(--status-on); }
  .log-line.error { color: var(--status-off); }
</style>
</head>
<body>

<div class="header">
  <h1>⬢ Dual Camera System</h1>
</div>

<div class="camera-grid">
  <!-- Camera 1 -->
  <div class="camera-card">
    <div class="camera-header">
      <div class="camera-title">Camera 1</div>
      <div class="status-indicator">
        <span class="status-dot" id="status-cam1"></span>
        <span id="status-text-cam1">Disconnected</span>
      </div>
    </div>
    <div class="video-container">
      <video id="video-cam1" autoplay playsinline muted></video>
      <div class="no-signal" id="no-signal-cam1">
        <div class="icon">⬡</div>
        <span>Awaiting signal</span>
      </div>
      <div class="osd" id="osd-cam1" style="display:none;">
        <span class="live-badge">LIVE</span>
        <span id="osd-time-cam1"></span>
      </div>
    </div>
  </div>

  <!-- Camera 2 -->
  <div class="camera-card">
    <div class="camera-header">
      <div class="camera-title">Camera 2</div>
      <div class="status-indicator">
        <span class="status-dot" id="status-cam2"></span>
        <span id="status-text-cam2">Disconnected</span>
      </div>
    </div>
    <div class="video-container">
      <video id="video-cam2" autoplay playsinline muted></video>
      <div class="no-signal" id="no-signal-cam2">
        <div class="icon">⬡</div>
        <span>Awaiting signal</span>
      </div>
      <div class="osd" id="osd-cam2" style="display:none;">
        <span class="live-badge">LIVE</span>
        <span id="osd-time-cam2"></span>
      </div>
    </div>
  </div>
</div>

<div class="controls">
  <button class="btn" id="btn-connect" onclick="connectAll()">Connect Both Cameras</button>
  <button class="btn disconnect" id="btn-disconnect" onclick="disconnectAll()" style="display:none;">Disconnect</button>
</div>

<div class="log-section">
  <div class="log-title">Event Log</div>
  <div class="log-box" id="log-box"></div>
</div>

<script>
(function() {
  "use strict";

  const ICE_CONFIG = {
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  };

  let ws = null;
  const cameras = {
    camera1: {
      id: "camera1",
      pc: null,
      video: document.getElementById("video-cam1"),
      noSignal: document.getElementById("no-signal-cam1"),
      osd: document.getElementById("osd-cam1"),
      osdTime: document.getElementById("osd-time-cam1"),
      statusDot: document.getElementById("status-cam1"),
      statusText: document.getElementById("status-text-cam1")
    },
    camera2: {
      id: "camera2",
      pc: null,
      video: document.getElementById("video-cam2"),
      noSignal: document.getElementById("no-signal-cam2"),
      osd: document.getElementById("osd-cam2"),
      osdTime: document.getElementById("osd-time-cam2"),
      statusDot: document.getElementById("status-cam2"),
      statusText: document.getElementById("status-text-cam2")
    }
  };

  const logBox = document.getElementById("log-box");
  const btnConnect = document.getElementById("btn-connect");
  const btnDisconnect = document.getElementById("btn-disconnect");

  function log(msg, level = "info") {
    console.log(`[DUAL-CAM] ${msg}`);
    const ts = new Date().toLocaleTimeString("en-GB", { hour12: false });
    const line = document.createElement("div");
    line.className = `log-line ${level}`;
    line.innerHTML = `<span class="ts">${ts}</span>${msg}`;
    logBox.appendChild(line);
    logBox.scrollTop = logBox.scrollHeight;
  }

  function updateStatus(cameraId, connected, text) {
    const cam = cameras[cameraId];
    cam.statusDot.classList.toggle("connected", connected);
    cam.statusText.textContent = text;
  }

  function setupPeerConnection(cameraId) {
    const cam = cameras[cameraId];
    cam.pc = new RTCPeerConnection(ICE_CONFIG);

    cam.pc.ontrack = (event) => {
      log(`${cameraId}: Video track received`, "success");
      cam.video.srcObject = event.streams[0];
      cam.noSignal.classList.add("hidden");
      cam.osd.style.display = "block";
      updateStatus(cameraId, true, "Streaming");
    };

    cam.pc.onicecandidate = (event) => {
      if (event.candidate) {
        ws.send(JSON.stringify({
          type: "candidate",
          camera: cameraId,
          candidate: event.candidate.candidate,
          sdpMLineIndex: event.candidate.sdpMLineIndex
        }));
      }
    };

    cam.pc.oniceconnectionstatechange = () => {
      log(`${cameraId}: ICE state → ${cam.pc.iceConnectionState}`, "info");
    };
  }

  async function handleOffer(cameraId, sdp) {
    const cam = cameras[cameraId];
    log(`${cameraId}: Received offer`, "info");

    await cam.pc.setRemoteDescription(new RTCSessionDescription({ type: "offer", sdp }));
    const answer = await cam.pc.createAnswer();
    await cam.pc.setLocalDescription(answer);

    ws.send(JSON.stringify({
      type: "answer",
      camera: cameraId,
      sdp: answer.sdp
    }));

    log(`${cameraId}: Answer sent`, "success");
  }

  async function handleCandidate(cameraId, candidate, sdpMLineIndex) {
    const cam = cameras[cameraId];
    if (candidate) {
      await cam.pc.addIceCandidate(new RTCIceCandidate({
        candidate,
        sdpMLineIndex
      }));
    }
  }

  async function connectAll() {
    btnConnect.disabled = true;
    log("Opening WebSocket...", "info");
    
    // Reset status indicators
    updateStatus("camera1", false, "Connecting...");
    updateStatus("camera2", false, "Connecting...");

    ws = new WebSocket("ws://" + window.location.host + "/ws");

    ws.onopen = () => {
      log("WebSocket connected", "success");
      
      // Setup peer connections for both cameras
      setupPeerConnection("camera1");
      setupPeerConnection("camera2");

      // Signal ready for both cameras
      ws.send(JSON.stringify({ type: "ready", camera: "camera1" }));
      ws.send(JSON.stringify({ type: "ready", camera: "camera2" }));

      log("Sent ready signals for both cameras", "info");
      
      btnConnect.style.display = "none";
      btnDisconnect.style.display = "inline-block";
    };

    ws.onmessage = async (event) => {
      const signal = JSON.parse(event.data);
      const cameraId = signal.camera;

      if (!cameraId || !cameras[cameraId]) return;

      if (signal.type === "offer") {
        await handleOffer(cameraId, signal.sdp);
      } else if (signal.type === "candidate") {
        await handleCandidate(cameraId, signal.candidate, signal.sdpMLineIndex);
      }
    };

    ws.onerror = () => {
      log("WebSocket error", "error");
      updateStatus("camera1", false, "Error");
      updateStatus("camera2", false, "Error");
    };

    ws.onclose = () => {
      log("WebSocket closed", "info");
      // Auto-cleanup if connection drops unexpectedly
      if (btnDisconnect.style.display !== "none") {
        cleanupConnections();
      }
    };
  }

  function cleanupConnections() {
    for (const cameraId in cameras) {
      const cam = cameras[cameraId];
      if (cam.pc) {
        cam.pc.close();
        cam.pc = null;
      }
      cam.video.srcObject = null;
      cam.noSignal.classList.remove("hidden");
      cam.osd.style.display = "none";
      updateStatus(cameraId, false, "Disconnected");
    }
    
    btnConnect.disabled = false;
    btnConnect.style.display = "inline-block";
    btnDisconnect.style.display = "none";
  }

  function disconnectAll() {
    log("Disconnecting...", "info");

    // Send disconnect signal to server
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: "disconnect", camera: "camera1" }));
      ws.send(JSON.stringify({ type: "disconnect", camera: "camera2" }));
    }

    cleanupConnections();

    if (ws) {
      ws.close();
      ws = null;
    }
    
    log("Disconnected", "success");
  }

  // Update OSD time
  setInterval(() => {
    const time = new Date().toLocaleTimeString("en-GB", { hour12: false });
    for (const cameraId in cameras) {
      const cam = cameras[cameraId];
      if (cam.osd.style.display !== "none") {
        cam.osdTime.textContent = time;
      }
    }
  }, 1000);

  window.connectAll = connectAll;
  window.disconnectAll = disconnectAll;
})();
</script>

</body>
</html>